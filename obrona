#define _CRT_SECURE_NO_WARNINGS
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <time.h>
#include <math.h>

#define MAX_NAZWA 100

typedef struct {
    char nazwa[MAX_NAZWA];
    char standard[3];
    int szerokosc;
    int wysokosc;
    int max_wartosc;
    int** piksele;
} Obraz;

typedef struct {
    Obraz* tablica;   // dynamiczna tablica obrazów
    int rozmiar;      // aktualna liczba obrazów w bazie
    int wybrany;      // indeks aktualnie wybranego obrazu (-1 jeśli brak)
} BazaObrazow;

void zwolnijObraz(Obraz* obr) {
    if (obr->piksele) {
        for (int i = 0; i < obr->wysokosc; i++)
            free(obr->piksele[i]);
        free(obr->piksele);
        obr->piksele = NULL;
    }
}

void zwolnijBaze(BazaObrazow* baza) {
    for (int i = 0; i < baza->rozmiar; i++) {
        zwolnijObraz(&baza->tablica[i]);
    }
    free(baza->tablica);
    baza->tablica = NULL;
    baza->rozmiar = 0;
    baza->wybrany = -1;
}

int pominKomentarze(FILE* plik) {
    int c;
    while ((c = fgetc(plik)) != EOF) {
        if (c == '#') {
            while ((c = fgetc(plik)) != '\n' && c != EOF);
        }
        else if (!isspace(c)) {
            ungetc(c, plik);
            return 1;
        }
    }
    return 0;
}

int wczytajObraz(Obraz* obr, const char* nazwaPliku) {
    zwolnijObraz(obr);
    FILE* plik = fopen(nazwaPliku, "r");
    if (!plik) {
        printf("Blad: Nie mozna otworzyc pliku %s\n", nazwaPliku);
        return 0;
    }

    pominKomentarze(plik);
    if (fscanf(plik, "%2s", obr->standard) != 1) {
        printf("Blad odczytu standardu pliku\n");
        fclose(plik);
        return 0;
    }
    pominKomentarze(plik);
    if (fscanf(plik, "%d %d", &obr->szerokosc, &obr->wysokosc) != 2) {
        printf("Blad odczytu rozmiarow obrazu\n");
        fclose(plik);
        return 0;
    }
    pominKomentarze(plik);
    if (fscanf(plik, "%d", &obr->max_wartosc) != 1) {
        printf("Blad odczytu maksymalnej wartosci piksela\n");
        fclose(plik);
        return 0;
    }

    obr->piksele = malloc(obr->wysokosc * sizeof(int*));
    if (!obr->piksele) {
        printf("Blad alokacji pamieci dla pikseli\n");
        fclose(plik);
        return 0;
    }
    for (int i = 0; i < obr->wysokosc; i++) {
        obr->piksele[i] = malloc(obr->szerokosc * sizeof(int));
        if (!obr->piksele[i]) {
            printf("Blad alokacji pamieci dla wiersza pikseli\n");
            for (int j = 0; j < i; j++) free(obr->piksele[j]);
            free(obr->piksele);
            obr->piksele = NULL;
            fclose(plik);
            return 0;
        }
    }

    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            pominKomentarze(plik);
            if (fscanf(plik, "%d", &obr->piksele[i][j]) != 1) {
                printf("Blad odczytu piksela [%d][%d]\n", i, j);
                for (int k = 0; k < obr->wysokosc; k++) free(obr->piksele[k]);
                free(obr->piksele);
                obr->piksele = NULL;
                fclose(plik);
                return 0;
            }
        }
    }

    fclose(plik);
    strcpy(obr->nazwa, nazwaPliku);
    printf("Wczytano: %s (%d x %d)\n", nazwaPliku, obr->szerokosc, obr->wysokosc);
    return 1;
}

int zapiszObraz(Obraz* obr, const char* nazwaPliku) {
    if (!obr->piksele) {
        printf("Blad: Brak obrazu do zapisania\n");
        return 0;
    }
    FILE* plik = fopen(nazwaPliku, "w");
    if (!plik) {
        printf("Blad: Nie mozna utworzyc pliku %s\n", nazwaPliku);
        return 0;
    }
    fprintf(plik, "%s\n", obr->standard);
    fprintf(plik, "%d %d\n", obr->szerokosc, obr->wysokosc);
    fprintf(plik, "%d\n", obr->max_wartosc);
    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            fprintf(plik, "%d ", obr->piksele[i][j]);
        }
        fprintf(plik, "\n");
    }
    fclose(plik);
    printf("Zapisano jako: %s\n", nazwaPliku);
    return 1;
}

Obraz* dodajObrazDoBazy(BazaObrazow* baza) {
    int nowyRozmiar = baza->rozmiar + 1;
    Obraz* temp = realloc(baza->tablica, nowyRozmiar * sizeof(Obraz));
    if (temp == NULL) {
        printf("Blad realokacji pamieci dla bazy obrazow\n");
        return NULL;
    }
    baza->tablica = temp;
    baza->rozmiar = nowyRozmiar;
    Obraz* nowyObraz = &baza->tablica[nowyRozmiar - 1];
    nowyObraz->piksele = NULL;
    nowyObraz->szerokosc = 0;
    nowyObraz->wysokosc = 0;
    nowyObraz->max_wartosc = 255;
    nowyObraz->nazwa[0] = '\0';
    nowyObraz->standard[0] = '\0';
    baza->wybrany = nowyRozmiar - 1;
    return nowyObraz;
}

void usunObrazZBazy(BazaObrazow* baza, int indeks) {
    if (indeks < 0 || indeks >= baza->rozmiar) {
        printf("Nieprawidlowy indeks obrazu\n");
        return;
    }
    zwolnijObraz(&baza->tablica[indeks]);
    if (indeks != baza->rozmiar - 1) {
        baza->tablica[indeks] = baza->tablica[baza->rozmiar - 1];
    }
    baza->rozmiar--;
    if (baza->rozmiar > 0) {
        Obraz* temp = realloc(baza->tablica, baza->rozmiar * sizeof(Obraz));
        if (temp == NULL) {
            printf("Blad realokacji pamieci przy zmniejszaniu bazy\n");
        }
        else {
            baza->tablica = temp;
        }
    }
    else {
        free(baza->tablica);
        baza->tablica = NULL;
    }

    if (baza->wybrany == indeks) {
        if (baza->rozmiar > 0) {
            baza->wybrany = 0;
        }
        else {
            baza->wybrany = -1;
        }
    }
    else if (baza->wybrany == baza->rozmiar) {
        if (baza->wybrany > indeks) {
            baza->wybrany--;
        }
    }
}

void wyswietlBaze(BazaObrazow* baza) {
    printf("\n--- Baza obrazow ---\n");
    printf("Liczba obrazow: %d\n", baza->rozmiar);
    if (baza->rozmiar == 0) {
        printf("Baza jest pusta.\n");
        return;
    }

    for (int i = 0; i < baza->rozmiar; i++) {
        Obraz* obr = &baza->tablica[i];
        printf("%d: %s (%d x %d)", i, obr->nazwa, obr->szerokosc, obr->wysokosc);
        if (i == baza->wybrany) printf(" <-- wybrany");
        printf("\n");
    }
}

void wybierzObraz(BazaObrazow* baza, int indeks) {
    if (indeks >= 0 && indeks < baza->rozmiar) {
        baza->wybrany = indeks;
        printf("Wybrano obraz: %s\n", baza->tablica[indeks].nazwa);
    }
    else {
        printf("Nieprawidlowy indeks obrazu\n");
    }
}

// FUNKCJE GENERUJĄCE GRADIENTY

void generujGradientLewaPrawa(Obraz* obr, int szerokosc, int wysokosc) {
    zwolnijObraz(obr);
    obr->szerokosc = szerokosc;
    obr->wysokosc = wysokosc;
    obr->max_wartosc = 255;
    strcpy(obr->standard, "P2");
    snprintf(obr->nazwa, MAX_NAZWA, "gradient_lewa_prawa_%dx%d.pgm", szerokosc, wysokosc);
    
    obr->piksele = malloc(wysokosc * sizeof(int*));
    for (int i = 0; i < wysokosc; i++) {
        obr->piksele[i] = malloc(szerokosc * sizeof(int));
        for (int j = 0; j < szerokosc; j++) {
            obr->piksele[i][j] = (j * 255) / (szerokosc - 1);
        }
    }
    printf("Wygenerowano gradient od lewej do prawej (%d x %d)\n", szerokosc, wysokosc);
}

void generujGradientGoraDol(Obraz* obr, int szerokosc, int wysokosc) {
    zwolnijObraz(obr);
    obr->szerokosc = szerokosc;
    obr->wysokosc = wysokosc;
    obr->max_wartosc = 255;
    strcpy(obr->standard, "P2");
    snprintf(obr->nazwa, MAX_NAZWA, "gradient_gora_dol_%dx%d.pgm", szerokosc, wysokosc);
    
    obr->piksele = malloc(wysokosc * sizeof(int*));
    for (int i = 0; i < wysokosc; i++) {
        obr->piksele[i] = malloc(szerokosc * sizeof(int));
        for (int j = 0; j < szerokosc; j++) {
            obr->piksele[i][j] = (i * 255) / (wysokosc - 1);
        }
    }
    printf("Wygenerowano gradient od gory do dolu (%d x %d)\n", szerokosc, wysokosc);
}

void generujGradientPrzekatna(Obraz* obr, int szerokosc, int wysokosc) {
    zwolnijObraz(obr);
    obr->szerokosc = szerokosc;
    obr->wysokosc = wysokosc;
    obr->max_wartosc = 255;
    strcpy(obr->standard, "P2");
    snprintf(obr->nazwa, MAX_NAZWA, "gradient_przekatna_%dx%d.pgm", szerokosc, wysokosc);
    
    obr->piksele = malloc(wysokosc * sizeof(int*));
    for (int i = 0; i < wysokosc; i++) {
        obr->piksele[i] = malloc(szerokosc * sizeof(int));
        for (int j = 0; j < szerokosc; j++) {
            float progX = (float)j / (szerokosc - 1);
            float progY = (float)i / (wysokosc - 1);
            float progPrzekatna = (progX + progY) / 2.0f;
            obr->piksele[i][j] = (int)(progPrzekatna * 255);
        }
    }
    printf("Wygenerowano gradient po przekatnej (%d x %d)\n", szerokosc, wysokosc);
}

void generujGradientRadialny(Obraz* obr, int szerokosc, int wysokosc) {
    zwolnijObraz(obr);
    obr->szerokosc = szerokosc;
    obr->wysokosc = wysokosc;
    obr->max_wartosc = 255;
    strcpy(obr->standard, "P2");
    snprintf(obr->nazwa, MAX_NAZWA, "gradient_radialny_%dx%d.pgm", szerokosc, wysokosc);
    
    float srodekX = (szerokosc - 1) / 2.0f;
    float srodekY = (wysokosc - 1) / 2.0f;
    float maxOdleglosc = sqrt(srodekX * srodekX + srodekY * srodekY);
    
    obr->piksele = malloc(wysokosc * sizeof(int*));
    for (int i = 0; i < wysokosc; i++) {
        obr->piksele[i] = malloc(szerokosc * sizeof(int));
        for (int j = 0; j < szerokosc; j++) {
            float dx = j - srodekX;
            float dy = i - srodekY;
            float odleglosc = sqrt(dx * dx + dy * dy);
            float prog = odleglosc / maxOdleglosc;
            obr->piksele[i][j] = 255 - (int)(prog * 255);
        }
    }
    printf("Wygenerowano gradient radialny (%d x %d)\n", szerokosc, wysokosc);
}

// FUNKCJE GENERUJĄCE OBRAZY

void generujSzachownice(Obraz* img) {
    if (!img) return;
    
    zwolnijObraz(img);
    
    strcpy(img->nazwa, "szachownica.pgm");
    strcpy(img->standard, "P2");
    img->szerokosc = 100;
    img->wysokosc = 100;
    img->max_wartosc = 255;
    
    int wartosc_bialych;
    printf("Podaj wartosc szarosci dla bialych pol (0-255): ");
    scanf("%d", &wartosc_bialych);
    
    if (wartosc_bialych < 0) wartosc_bialych = 0;
    if (wartosc_bialych > 255) wartosc_bialych = 255;
    
    img->piksele = malloc(img->wysokosc * sizeof(int*));
    for (int i = 0; i < img->wysokosc; i++) {
        img->piksele[i] = malloc(img->szerokosc * sizeof(int));
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        for (int j = 0; j < img->szerokosc; j++) {
            if ((i / 10 + j / 10) % 2 == 0) {
                img->piksele[i][j] = 0;
            }
            else {
                img->piksele[i][j] = wartosc_bialych;
            }
        }
    }
    
    printf("Wygenerowano szachownice %dx%d\n", img->szerokosc, img->wysokosc);
}

void generujSzachownice2(Obraz* img) {
    if (!img) return;
    
    zwolnijObraz(img);
    
    strcpy(img->nazwa, "szachownica2.pgm");
    strcpy(img->standard, "P2");
    img->szerokosc = 100;
    img->wysokosc = 100;
    img->max_wartosc = 255;
    
    int wartosc_bialych;
    printf("Podaj wartosc szarosci dla bialych pol (0-255): ");
    scanf("%d", &wartosc_bialych);
    
    if (wartosc_bialych < 0) wartosc_bialych = 0;
    if (wartosc_bialych > 255) wartosc_bialych = 255;
    
    img->piksele = malloc(img->wysokosc * sizeof(int*));
    for (int i = 0; i < img->wysokosc; i++) {
        img->piksele[i] = malloc(img->szerokosc * sizeof(int));
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        for (int j = 0; j < img->szerokosc; j++) {
            img->piksele[i][j] = 0;
        }
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        for (int j = 0; j < img->szerokosc; j++) {
            if ((i + j) % 2 == 1) {
                img->piksele[i][j] = wartosc_bialych;
            }
        }
    }
    
    printf("Wygenerowano szachownice (wersja 2) %dx%d\n", img->szerokosc, img->wysokosc);
}

void generujChoinke(Obraz* img) {
    if (!img) return;
    
    zwolnijObraz(img);
    
    strcpy(img->nazwa, "choinka.pgm");
    strcpy(img->standard, "P2");
    img->szerokosc = 100;
    img->wysokosc = 100;
    img->max_wartosc = 255;
    
    img->piksele = malloc(img->wysokosc * sizeof(int*));
    for (int i = 0; i < img->wysokosc; i++) {
        img->piksele[i] = malloc(img->szerokosc * sizeof(int));
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        for (int j = 0; j < img->szerokosc; j++) {
            img->piksele[i][j] = 0;
        }
    }
    
    int srodek = img->szerokosc / 2;
    
    for (int i = 0; i < img->wysokosc / 2; i++) {
        for (int j = -i; j <= i; j++) {
            if (srodek + j >= 0 && srodek + j < img->szerokosc) {
                img->piksele[i][srodek + j] = img->max_wartosc;
            }
        }
    }
    
    for (int i = img->wysokosc / 2; i < img->wysokosc; i++) {
        for (int j = -img->wysokosc / 10; j <= img->wysokosc / 10; j++) {
            if (srodek + j >= 0 && srodek + j < img->szerokosc) {
                img->piksele[i][srodek + j] = img->max_wartosc;
            }
        }
    }
    
    printf("Wygenerowano choinke %dx%d\n", img->szerokosc, img->wysokosc);
}

void generujGwiazdke(Obraz* img) {
    if (!img) return;
    
    zwolnijObraz(img);
    
    strcpy(img->nazwa, "gwiazdka.pgm");
    strcpy(img->standard, "P2");
    img->szerokosc = 100;
    img->wysokosc = 100;
    img->max_wartosc = 255;
    
    img->piksele = malloc(img->wysokosc * sizeof(int*));
    for (int i = 0; i < img->wysokosc; i++) {
        img->piksele[i] = malloc(img->szerokosc * sizeof(int));
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        for (int j = 0; j < img->szerokosc; j++) {
            img->piksele[i][j] = 0;
        }
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        if (img->szerokosc / 2 < img->szerokosc) {
            img->piksele[i][img->szerokosc / 2] = img->max_wartosc;
        }
        if (img->szerokosc / 2 - 1 >= 0) {
            img->piksele[i][img->szerokosc / 2 - 1] = img->max_wartosc;
        }
    }
    
    for (int j = 0; j < img->szerokosc; j++) {
        if (img->wysokosc / 2 < img->wysokosc) {
            img->piksele[img->wysokosc / 2][j] = img->max_wartosc;
        }
        if (img->wysokosc / 2 - 1 >= 0) {
            img->piksele[img->wysokosc / 2 - 1][j] = img->max_wartosc;
        }
    }
    
    for (int i = 0; i < img->wysokosc; i++) {
        if (i < img->szerokosc) {
            img->piksele[i][i] = img->max_wartosc;
        }
        int j = img->wysokosc - i - 1;
        if (j >= 0 && j < img->szerokosc) {
            img->piksele[img->wysokosc - i - 1][i] = img->max_wartosc;
        }
    }
    
    printf("Wygenerowano gwiazdke %dx%d\n", img->szerokosc, img->wysokosc);
}

void obrot90(Obraz* obr) {
    if (!obr->piksele) return;
    int nowa_szerokosc = obr->wysokosc;
    int nowa_wysokosc = obr->szerokosc;
    int** nowe_piksele = malloc(nowa_wysokosc * sizeof(int*));
    for (int i = 0; i < nowa_wysokosc; i++)
        nowe_piksele[i] = malloc(nowa_szerokosc * sizeof(int));

    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            nowe_piksele[j][nowa_szerokosc - 1 - i] = obr->piksele[i][j];
        }
    }
    zwolnijObraz(obr);
    obr->szerokosc = nowa_szerokosc;
    obr->wysokosc = nowa_wysokosc;
    obr->piksele = nowe_piksele;
    printf("Obrocono o 90 stopni\n");
}

void obrot180(Obraz* obr) {
    if (!obr->piksele) return;
    int** nowe_piksele = malloc(obr->wysokosc * sizeof(int*));
    for (int i = 0; i < obr->wysokosc; i++)
        nowe_piksele[i] = malloc(obr->szerokosc * sizeof(int));

    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            nowe_piksele[obr->wysokosc - 1 - i][obr->szerokosc - 1 - j] = obr->piksele[i][j];
        }
    }
    zwolnijObraz(obr);
    obr->piksele = nowe_piksele;
    printf("Obrocono o 180 stopni\n");
}

void obrot270(Obraz* obr) {
    if (!obr->piksele) return;
    int nowa_szerokosc = obr->wysokosc;
    int nowa_wysokosc = obr->szerokosc;
    int** nowe_piksele = malloc(nowa_wysokosc * sizeof(int*));
    for (int i = 0; i < nowa_wysokosc; i++)
        nowe_piksele[i] = malloc(nowa_szerokosc * sizeof(int));

    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            nowe_piksele[nowa_wysokosc - 1 - j][i] = obr->piksele[i][j];
        }
    }
    zwolnijObraz(obr);
    obr->szerokosc = nowa_szerokosc;
    obr->wysokosc = nowa_wysokosc;
    obr->piksele = nowe_piksele;
    printf("Obrocono o 270 stopni\n");
}

void negatyw(Obraz* obr) {
    if (!obr->piksele) return;
    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            obr->piksele[i][j] = obr->max_wartosc - obr->piksele[i][j];
        }
    }
    printf("Wykonano negatyw\n");
}

void histogram(Obraz* obr, const char* nazwaPliku) {
    if (!obr->piksele) return;
    int* hist = calloc(obr->max_wartosc + 1, sizeof(int));
    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            hist[obr->piksele[i][j]]++;
        }
    }
    FILE* plik = fopen(nazwaPliku, "w");
    if (plik) {
        fprintf(plik, "Odcien,LiczbaPikseli\n");
        for (int i = 0; i <= obr->max_wartosc; i++) {
            fprintf(plik, "%d,%d\n", i, hist[i]);
        }
        fclose(plik);
        printf("Histogram zapisano do: %s\n", nazwaPliku);
    }
    free(hist);
}

void statystyki(Obraz* obr) {
    if (!obr->piksele) return;
    int min = obr->max_wartosc;
    int max = 0;
    long long suma = 0;
    int liczba_pikseli = obr->szerokosc * obr->wysokosc;
    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            int wartosc = obr->piksele[i][j];
            if (wartosc < min) min = wartosc;
            if (wartosc > max) max = wartosc;
            suma += wartosc;
        }
    }
    double srednia = (double)suma / liczba_pikseli;
    printf("Statystyki obrazu:\n");
    printf("Minimalna wartosc: %d\n", min);
    printf("Maksymalna wartosc: %d\n", max);
    printf("Srednia wartosc: %.2f\n", srednia);
}

void odbicie(Obraz* obr, int kierunek) {
    if (!obr->piksele) return;
    int** nowe_piksele = malloc(obr->wysokosc * sizeof(int*));
    for (int i = 0; i < obr->wysokosc; i++)
        nowe_piksele[i] = malloc(obr->szerokosc * sizeof(int));

    if (kierunek == 1) { // pionowe
        for (int i = 0; i < obr->wysokosc; i++) {
            for (int j = 0; j < obr->szerokosc; j++) {
                nowe_piksele[i][obr->szerokosc - 1 - j] = obr->piksele[i][j];
            }
        }
        printf("Odbicie pionowe\n");
    }
    else { // poziome
        for (int i = 0; i < obr->wysokosc; i++) {
            for (int j = 0; j < obr->szerokosc; j++) {
                nowe_piksele[obr->wysokosc - 1 - i][j] = obr->piksele[i][j];
            }
        }
        printf("Odbicie poziome\n");
    }
    zwolnijObraz(obr);
    obr->piksele = nowe_piksele;
}

void szumPieprzSol(Obraz* obr, float prawdopodobienstwo) {
    if (!obr->piksele) return;
    srand(time(NULL));
    int liczba_pikseli = obr->szerokosc * obr->wysokosc;
    int liczba_zmian = (int)(liczba_pikseli * prawdopodobienstwo);
    for (int i = 0; i < liczba_zmian; i++) {
        int x = rand() % obr->szerokosc;
        int y = rand() % obr->wysokosc;
        if (rand() % 2 == 0) {
            obr->piksele[y][x] = 0;
        }
        else {
            obr->piksele[y][x] = obr->max_wartosc;
        }
    }
    printf("Dodano szum 'pieprz i sol' (p=%.3f)\n", prawdopodobienstwo);
}

int porownaj(const void* a, const void* b) {
    return (*(int*)a - *(int*)b);
}

void filtrMedianowy(Obraz* obr) {
    if (!obr->piksele) return;
    int** nowe_piksele = malloc(obr->wysokosc * sizeof(int*));
    for (int i = 0; i < obr->wysokosc; i++)
        nowe_piksele[i] = malloc(obr->szerokosc * sizeof(int));
    int okno[9];
    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            int licznik = 0;
            for (int m = -1; m <= 1; m++) {
                for (int n = -1; n <= 1; n++) {
                    int y = i + m;
                    int x = j + n;
                    if (y >= 0 && y < obr->wysokosc && x >= 0 && x < obr->szerokosc) {
                        okno[licznik++] = obr->piksele[y][x];
                    }
                }
            }
            if (licznik > 0) {
                qsort(okno, licznik, sizeof(int), porownaj);
                nowe_piksele[i][j] = okno[licznik / 2];
            }
            else {
                nowe_piksele[i][j] = obr->piksele[i][j];
            }
        }
    }
    zwolnijObraz(obr);
    obr->piksele = nowe_piksele;
    printf("Zastosowano filtr medianowy 3x3\n");
}

void filtrGaussa(Obraz* obr) {
    if (!obr->piksele) return;
    int** nowe_piksele = malloc(obr->wysokosc * sizeof(int*));
    for (int i = 0; i < obr->wysokosc; i++)
        nowe_piksele[i] = malloc(obr->szerokosc * sizeof(int));
    int maska[3][3] = { {1, 2, 1}, {2, 4, 2}, {1, 2, 1} };
    for (int i = 0; i < obr->wysokosc; i++) {
        for (int j = 0; j < obr->szerokosc; j++) {
            int suma = 0;
            int licznik = 0;
            for (int m = -1; m <= 1; m++) {
                for (int n = -1; n <= 1; n++) {
                    int y = i + m;
                    int x = j + n;
                    if (y >= 0 && y < obr->wysokosc && x >= 0 && x < obr->szerokosc) {
                        suma += obr->piksele[y][x] * maska[m + 1][n + 1];
                        licznik += maska[m + 1][n + 1];
                    }
                }
            }
            if (licznik > 0) {
                nowe_piksele[i][j] = suma / licznik;
            }
            else {
                nowe_piksele[i][j] = obr->piksele[i][j];
            }
        }
    }
    zwolnijObraz(obr);
    obr->piksele = nowe_piksele;
    printf("Zastosowano filtr Gaussa 3x3\n");
}

int main() {
    BazaObrazow baza = { NULL, 0, -1 };
    char plikWe[MAX_NAZWA];
    char plikWy[MAX_NAZWA];
    int wybor = -1;
    float p;
    int indeks;
    int szerokosc, wysokosc;
    Obraz* nowy;

    while (wybor != 0) {
        printf("\n--- MENU BAZY OBRAZOW ---\n");
        printf("1. Dodaj obraz (wczytaj z pliku)\n");
        printf("2. Generuj gradient - lewa do prawej\n");
        printf("3. Generuj gradient - gora do dolu\n");
        printf("4. Generuj gradient - przekatna\n");
        printf("5. Generuj gradient - radialny\n");
        printf("6. Generuj szachownice (wersja 1)\n");
        printf("7. Generuj szachownice (wersja 2)\n");
        printf("8. Generuj choinke\n");
        printf("9. Generuj gwiazdke\n");
        printf("10. Wyswietl baze\n");
        printf("11. Wybierz obraz\n");
        printf("12. Usun obraz\n");
        printf("13. Zapisz wybrany obraz\n");
        printf("\n--- PRZETWARZANIE WYBRANEGO OBRAZU ---\n");
        printf("14. Obrót 90°\n");
        printf("15. Obrót 180°\n");
        printf("16. Obrót 270°\n");
        printf("17. Negatyw\n");
        printf("18. Histogram (zapis do CSV)\n");
        printf("19. Statystyki\n");
        printf("20. Odbicie pionowe\n");
        printf("21. Odbicie poziome\n");
        printf("22. Szum 'pieprz i sol'\n");
        printf("23. Filtr medianowy\n");
        printf("24. Filtr Gaussa\n");
        printf("0. Wyjscie\n");
        printf("Wybor: ");
        scanf("%d", &wybor);

        switch (wybor) {
        case 1: // Dodaj obraz z pliku
            printf("Plik do odczytu: ");
            scanf("%s", plikWe);
            nowy = dodajObrazDoBazy(&baza);
            if (nowy) {
                if (!wczytajObraz(nowy, plikWe)) {
                    usunObrazZBazy(&baza, baza.rozmiar - 1);
                }
            }
            break;

        case 2: // Generuj gradient lewa-prawa
            printf("Podaj szerokosc: ");
            scanf("%d", &szerokosc);
            printf("Podaj wysokosc: ");
            scanf("%d", &wysokosc);
            if (szerokosc > 0 && wysokosc > 0) {
                nowy = dodajObrazDoBazy(&baza);
                if (nowy) {
                    generujGradientLewaPrawa(nowy, szerokosc, wysokosc);
                }
            }
            else {
                printf("Nieprawidlowe wymiary!\n");
            }
            break;

        case 3: // Generuj gradient gora-dol
            printf("Podaj szerokosc: ");
            scanf("%d", &szerokosc);
            printf("Podaj wysokosc: ");
            scanf("%d", &wysokosc);
            if (szerokosc > 0 && wysokosc > 0) {
                nowy = dodajObrazDoBazy(&baza);
                if (nowy) {
                    generujGradientGoraDol(nowy, szerokosc, wysokosc);
                }
            }
            else {
                printf("Nieprawidlowe wymiary!\n");
            }
            break;

        case 4: // Generuj gradient po przekątnej
            printf("Podaj szerokosc: ");
            scanf("%d", &szerokosc);
            printf("Podaj wysokosc: ");
            scanf("%d", &wysokosc);
            if (szerokosc > 0 && wysokosc > 0) {
                nowy = dodajObrazDoBazy(&baza);
                if (nowy) {
                    generujGradientPrzekatna(nowy, szerokosc, wysokosc);
                }
            }
            else {
                printf("Nieprawidlowe wymiary!\n");
            }
            break;

        case 5: // Generuj gradient radialny
            printf("Podaj szerokosc: ");
            scanf("%d", &szerokosc);
            printf("Podaj wysokosc: ");
            scanf("%d", &wysokosc);
            if (szerokosc > 0 && wysokosc > 0) {
                nowy = dodajObrazDoBazy(&baza);
                if (nowy) {
                    generujGradientRadialny(nowy, szerokosc, wysokosc);
                }
            }
            else {
                printf("Nieprawidlowe wymiary!\n");
            }
            break;

        case 6: // Generuj szachownice
            nowy = dodajObrazDoBazy(&baza);
            if (nowy) {
                generujSzachownice(nowy);
            }
            break;
            
        case 7: // Generuj szachownice (wersja 2)
            nowy = dodajObrazDoBazy(&baza);
            if (nowy) {
                generujSzachownice2(nowy);
            }
            break;
            
        case 8: // Generuj choinke
            nowy = dodajObrazDoBazy(&baza);
            if (nowy) {
                generujChoinke(nowy);
            }
            break;
            
        case 9: // Generuj gwiazdke
            nowy = dodajObrazDoBazy(&baza);
            if (nowy) {
                generujGwiazdke(nowy);
            }
            break;

        case 10: // Wyswietl baze
            wyswietlBaze(&baza);
            break;

        case 11: // Wybierz obraz
            printf("Podaj indeks obrazu: ");
            scanf("%d", &indeks);
            wybierzObraz(&baza, indeks);
            break;

        case 12: // Usun obraz
            printf("Podaj indeks obrazu do usuniecia: ");
            scanf("%d", &indeks);
            usunObrazZBazy(&baza, indeks);
            break;

        case 13: // Zapisz wybrany obraz
            if (baza.wybrany >= 0) {
                printf("Plik do zapisu: ");
                scanf("%s", plikWy);
                zapiszObraz(&baza.tablica[baza.wybrany], plikWy);
            }
            else {
                printf("Nie wybrano obrazu.\n");
            }
            break;

        case 14: // Obrót 90
            if (baza.wybrany >= 0) obrot90(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 15: // Obrót 180
            if (baza.wybrany >= 0) obrot180(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 16: // Obrót 270
            if (baza.wybrany >= 0) obrot270(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 17: // Negatyw
            if (baza.wybrany >= 0) negatyw(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 18: // Histogram
            if (baza.wybrany >= 0) {
                printf("Nazwa pliku CSV: ");
                scanf("%s", plikWy);
                histogram(&baza.tablica[baza.wybrany], plikWy);
            }
            else printf("Nie wybrano obrazu.\n");
            break;

        case 19: // Statystyki
            if (baza.wybrany >= 0) statystyki(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 20: // Odbicie pionowe
            if (baza.wybrany >= 0) odbicie(&baza.tablica[baza.wybrany], 1);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 21: // Odbicie poziome
            if (baza.wybrany >= 0) odbicie(&baza.tablica[baza.wybrany], 0);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 22: // Szum
            if (baza.wybrany >= 0) {
                printf("Podaj prawdopodobienstwo szumu (0.0-1.0): ");
                scanf("%f", &p);
                if (p >= 0.0f && p <= 1.0f) {
                    szumPieprzSol(&baza.tablica[baza.wybrany], p);
                }
                else printf("Nieprawidlowe prawdopodobienstwo!\n");
            }
            else printf("Nie wybrano obrazu.\n");
            break;

        case 23: // Filtr medianowy
            if (baza.wybrany >= 0) filtrMedianowy(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 24: // Filtr Gaussa
            if (baza.wybrany >= 0) filtrGaussa(&baza.tablica[baza.wybrany]);
            else printf("Nie wybrano obrazu.\n");
            break;

        case 0: // Wyjscie
            printf("Koniec programu.\n");
            break;

        default:
            printf("Nieprawidlowy wybor!\n");
        }
    }

    zwolnijBaze(&baza);
    return 0;
}
